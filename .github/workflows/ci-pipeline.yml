name: ci-pipeline

on:
  push:
    branches: [ testing ]
  pull_request:
    branches: [ testing ]

jobs:
# ---------- Code Quality ----------
  codelevel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=ksami13200_cap-stone-project2
            -Dsonar.organization=ksami13200
            -Dsonar.sources=.

      - name: Fetch Sonar Metrics
        run: |
          mkdir -p reports/sonar
          curl -s -u ${{ secrets.SONAR_TOKEN }}: \
          "https://sonarcloud.io/api/measures/component?component=ksami13200_cap-stone-project2&metricKeys=bugs,vulnerabilities,code_smells,coverage" \
          -o reports/sonar/metrics.json

      - name: Generate Sonar Report
        run: |
          echo "# Sonar Metrics" > reports/sonar/report.md
          echo "| Metric | Value |" >> reports/sonar/report.md
          echo "|------|-------|" >> reports/sonar/report.md
          jq -r '.component.measures[] | "| \(.metric) | \(.value) |"' reports/sonar/metrics.json >> reports/sonar/report.md

      - uses: actions/upload-artifact@v4
        with:
          name: sonar-report
          path: reports/sonar/

# ---------- Build / Scan / Push ----------
  docker-build:
    runs-on: ubuntu-latest
    needs: codelevel
    strategy:
      matrix:
        include:
          - image: ourplant-backend
            context: .
            file: ./Dockerfile
          - image: ourplant-frontend
            context: .
            file: ./nginx/Dockerfile
          - image: ourplant-db
            context: ./db
            file: ./db/Dockerfile

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build image
        run: |
          docker build \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image }}:${{ github.sha }} \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image }}:latest \
          -f ${{ matrix.file }} \
          ${{ matrix.context }}

      - name: Trivy Scan (Image)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image }}:${{ github.sha }}
          format: json
          output: trivy-${{ matrix.image }}.json
          severity: CRITICAL,HIGH
          exit-code: 1

      - uses: actions/upload-artifact@v4
        with:
          name: trivy-report-${{ matrix.image }}
          path: trivy-${{ matrix.image }}.json

      - name: Push image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image }}:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image }}:latest

# ---------- Helm Update ----------
  update-helm:
    runs-on: ubuntu-latest
    needs: docker-build
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Update Helm tag
        run: |
          sed -i "s|tag:.*|tag: ${GITHUB_SHA}|g" helm/ourplant/values.yaml

      - name: Commit & Push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add helm/ourplant/values.yaml
          git commit -m "ci: update image tag to ${GITHUB_SHA}"
          git push
